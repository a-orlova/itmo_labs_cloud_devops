# Лабораторная №2 по DevOps

Выполнили:

**Орлова Алёна (К3223)**

**Феофанов Никита (К3222)**

# Задание
1. Написать “плохой” Dockerfile, в котором есть не менее трех “bad practices” по написанию докерфайлов
2. Написать “хороший” Dockerfile, в котором эти плохие практики исправлены
3. Описать каждую из плохих практик в плохом докерфайле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат
4. Описать 2 плохих практики по работе с контейнерами. ! Не по написанию докерфайлов, а о том, как даже используя хороший докерфайл можно накосячить именно в работе с контейнерами.

# Устанавливаем докер

Начинаем лабораторную работу с установки докера. Для этого пишем в терминале поочередно следующие команды:

```bash
sudo apt update
sudo apt install apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
sudo apt update
apt-cache policy docker-ce
sudo apt install docker-ce
sudo systemctl status docker
```
Получаем такой вывод, значит все получилось:

![image](https://github.com/user-attachments/assets/4ad21e55-1866-4ae5-8c31-f00b795fa872)

Докер успешно установлен, переходим к первому заданию лабораторной работы. 

# "Плохой" Dockerfile
В первую очередь хочется вообще узнать, что за такие "bad practices" по написанию докерфайлов существуют. Просерчив инет, выделили ряд основных и наиболее часто встречающихся:

* использование latest версии образа
* множественные команды RUN
* отсутствие очистки временных файлов
* установка ненужных пакетов
* отсутствие многослойной сборки 
* копирование лишних файлов в контейнер
* запуск приложения от имени root
* использование тяжелых базовых образов
* излишние права
* установка переменных окружения внутри докерфайла
* использование ADD вместо COPY без необходимости
* не указан рабочий каталог 

Наш "плохой" докерфайл сделали вот таким:
```bash
FROM python:3.9

RUN apt-get update && apt-get install -y vim
RUN pip install flask
RUN pip install requests

COPY . /app
WORKDIR /app
RUN chmod 777 /app

CMD ["python", "app.py"]
```

В нём мы использовали 4 ошибки:

**1) Установка ненужного пакета**

*Это плохо*, так как установка редактора vim в контейнер по факту избыточное действиt, которое только утяжеляет размер образа

*Чтобы это исправить*, необходимо просто устанавливать только необходимые для работы приложения пакеты

**2) Три команды RUN для установки зависимостей**

*Это плохо*, потому что такой использование одной и той же команды для установки пакетов по несколько раз создаёт несколько слоёв и увеличивает размер образа

*Чтобы это исправить*, нужно просто объединить всё в одну едиственную установку

**3) Использование chmod 777**

*Это плохо*, так как позволяет любому пользователю, в том числе и потенциально вредоносным, вносить изменения в файлы, это просто небезопасно

*Чтобы это исправить*, надо применять только самые необходимые права, например 644 или 755

**4) Работа от root**

*Это плохо*, ведь по умолчанию докер работает от имени root, и это рискованно, так как при атаке на контейнер или его взломе, тот, кто атакует, получает лишний доступ

*Чтобы это исправить*, нужно создать юзера уже с ограниченными правами и переключиться на него

# "Хороший" Dockerfile

Теперь мы пишем хороший докерфайл, где исправлены все ошибки:
```bash
FROM python:3.9

RUN apt-get update && \
    apt-get install -y --no-install-recommends python3-pip && \
    pip install flask requests && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY . /app
WORKDIR /app
RUN chmod 755 /app

RUN useradd -ms /bin/bash appuser
USER appuser

CMD ["python", "app.py"]

```

Для начала мы удалили ненужный vim, затем в блоке RUN объединили все команды в одну, а еще добавили очистку кэша и флаг --no-install-recommends, который помогает избежать установки рекомендованных пакетов. Также мы стали использовать минимальные права доступа для файлов и добавили нового пользователя с ограниченными правами 

Все эти исправления повлияли на результат:
- уменьшилось количество слоев в образе, улучшилась производительность
- уменьшился размер образа из-за удаления ненужных пакетов
- повысилась безопасность контейнера из-за изменения прав

# Плохие практики по работе с контейнерами

**Нет ограничения ресурсов**

Для контейнера важно ограничить ресурсы, просто потому что если этого не сделать, он может занять всю свободную память и процессор на хосте, а это уже приведет к сбоям других процессов

*Исправление:* использовать флаги `--memory` и `--cpus` при запуске контейнера, чтобы ограничить доступные ресурсы

**Не надо полагаться на IP-адреса** 

У каждого контейнера есть собственный IP-адрес, но он может поменяться после перезапуска контейнера, из-за чего работа приложения может прекратиться

*Исправление:* если приложению нужно взаимодействовать с другим контейнером, то надо пользоваться переменными среды и именами узлов, которые не меняются



