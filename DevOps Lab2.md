# Лабораторная №2 по DevOps

Выполнили:

**Орлова Алёна (К3223)**

**Феофанов Никита (К3222)**

# Задание
1. Написать “плохой” Dockerfile, в котором есть не менее трех “bad practices” по написанию докерфайлов
2. Написать “хороший” Dockerfile, в котором эти плохие практики исправлены
3. Описать каждую из плохих практик в плохом докерфайле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат
4. Описать 2 плохих практики по работе с контейнерами. ! Не по написанию докерфайлов, а о том, как даже используя хороший докерфайл можно накосячить именно в работе с контейнерами.

# Устанавливаем докер

Начинаем лабораторную работу с установки докера. Для этого пишем в терминале поочередно следующие команды:

```bash
sudo apt update
sudo apt install apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
sudo apt update
apt-cache policy docker-ce
sudo apt install docker-ce
sudo systemctl status docker
```
Получаем такой вывод, значит все получилось:

![image](https://github.com/user-attachments/assets/4ad21e55-1866-4ae5-8c31-f00b795fa872)

Докер успешно установлен, переходим к первому заданию лабораторной работы. 

# "Плохой" Dockerfile
В первую очередь хочется вообще узнать, что за такие "bad practices" по написанию докерфайлов существуют. Просерчив инет, выделили ряд основных и наиболее часто встречающихся:

* использование latest версии образа
* множественные команды RUN
* отсутствие очистки временных файлов
* установка ненужных пакетов
* отсутствие многослойной сборки 
* копирование лишних файлов в контейнер
* запуск приложения от имени root
* использование тяжелых базовых образов
* излишние права
* установка переменных окружения внутри докерфайла
* использование ADD вместо COPY без необходимости
* не указан рабочий каталог 

Наш "плохой" докерфайл сделали вот таким:
```bash
FROM python:3.9

RUN apt-get update && apt-get install -y vim
RUN pip install flask
RUN pip install requests

COPY . /app
WORKDIR /app
RUN chmod 777 /app
ENV ENVIRONMENT=production
CMD ["python", "app.py"]
```

В нём мы использовали 5 распространенных ошибок:

**1) Установка ненужного пакета**

*Это плохо*, так как установка редактора vim в контейнер для продакшена по факту избыточное действие. Подобный инструмент не нужен для запуска приложения и лишь утяжеляет размер образа

*Чтобы это исправить*, необходимо просто устанавливать только необходимые для работы приложения зависимости

**2) Три команды RUN для установки зависимостей**

*Это плохо*, потому что такой подход к множественному использованию одной и той же команды для установки Python-пакетов создаёт несколько слоёв и увеличивает размер образа

*Чтобы это исправить*, нужно просто объединить всё в одну едиственную установку

**3) Использование слишком широких прав (chmod 777)**

*Это плохо*, так как это позволяет любому пользователю, в том числе и потенциально вредоносным, вносить изменения в файлы в директории, просто небезопасно

*Чтобы это исправить*, применять только самые необходимые права, например 644 или 755

**4) Отсутствие минимизации прав пользователя или работа от root**

*Это плохо*, ведь по умолчанию докер работает от имени root, и это рискованно, так как при атаке на контейнер или при его взломе атакующий получает root-доступ

*Чтобы это исправить*, создать юзера с ограниченными правами и переключиться на него

**5) Переменные окружения внутри докерфайла**

*Это плохо*, потому что это затрудняет управление и переиспользование образов в различных средах, например, если нужно будет запустить контейнер в другой среде, то придется либо менять докерфайл, либо переопределять переменные при запуске контейнера

*Чтобы это исправить*, нужно просто использовать внешние конфигурационные файлы или передавать переменные окружения при запуске контейнера

# "Хороший" Dockerfile

Теперь мы пишем хороший докерфайл, где исправлены все ошибки:
```bash
FROM python:3.9

RUN apt-get update && \
    apt-get install -y --no-install-recommends python3-pip && \
    pip install flask requests && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY . /app
WORKDIR /app
RUN chmod 755 /app

RUN useradd -ms /bin/bash appuser
USER appuser

CMD ["python", "app.py"]

```

Для начала мы удалили ненужный vim, затем в блоке RUN объединили все команды в одну, а еще добавили очистку кэша и флаг --no-install-recommends, который помогает избежать установки рекомендованных пакетов. Также мы стали использовать минимальные права доступа для файлов, добавили нового пользователя с ограниченными правами и убрали жесткую установку переменной окружения.

Все эти исправления повлияли на результат:
- уменьшилось количество слоев в образе, что улучшило производительность
- уменьшился размер образа из-за удаления ненужных пакетов
- повысилась безопасность контейнера из-за изменения прав
- упростился процесс развертывания в разных средах после удаления переменной окружения

# Плохие практики по работе с контейнерами

**Отсутствие ограничения ресурсов (память и процессор)**

Для контейнера важно ограничить ресурсы, просто потому что если этого не сделать, он может занять всю свободную память и процессор на хосте, а это уже приведет к сбоям других процессов

*Исправление:* использовать флаги `--memory` и `--cpus` при запуске контейнера, чтобы ограничить доступные ресурсы

**Неправильная настройка сетевых режимов**

Если запустить несколько контейнеров в одном сетевом режиме, то это может привести к обмениванию данными между этими контейнерами, что создает риски безопасности

*Исправление:* использовать отдельные сети или настройки сети bridge, чтобы изолировать их друг от друга, и они не могли взаимодействовать, если это не нужно

